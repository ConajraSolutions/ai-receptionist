<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo - Vapi Web Call</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #dc3545;
        }
        .status.calling {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #17a2b8;
        }
        button {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .start-call {
            background: #28a745;
            color: white;
        }
        .start-call:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.3);
        }
        .end-call {
            background: #dc3545;
            color: white;
        }
        .end-call:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220,53,69,0.3);
        }
        .info {
            font-size: 12px;
            color: #666;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-top: 20px;
        }
        .info strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
        }
        .volume-indicator {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }
        .volume-level {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 4px;
        }
        .transcript {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 13px;
            display: none;
        }
        .transcript.active {
            display: block;
        }
        .transcript-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .transcript-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .transcript-user {
            color: #0c5460;
            font-weight: 600;
        }
        .transcript-assistant {
            color: #155724;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è Demo</h1>
        <div class="subtitle">Talk to your AI assistant using Vapi</div>

        <div id="status" class="status loading">
            üîÑ Loading assistant configuration...
        </div>

        <div id="volume-container" style="display: none;">
            <small style="color: #666;">Voice Activity</small>
            <div class="volume-indicator">
                <div id="volume-level" class="volume-level"></div>
            </div>
        </div>

        <button id="start-call" class="start-call" disabled>
            üìû Start Call
        </button>

        <button id="end-call" class="end-call" style="display: none;" disabled>
            ‚ùå End Call
        </button>

        <div id="transcript" class="transcript">
            <strong>Conversation:</strong>
            <div id="transcript-content"></div>
        </div>

        <div class="info">
            <strong>Instructions:</strong>
            Click "Start Call" to begin talking with the AI receptionist.
            Make sure your microphone is enabled. The assistant can help you
            book appointments and check availability.
        </div>

        <div id="assistant-info" class="info" style="display: none;">
            <strong>Assistant Details:</strong>
            <div id="assistant-details"></div>
        </div>
    </div>

    <script type="module">
        import Vapi from 'https://esm.sh/@vapi-ai/web@2.3.2';

        console.log('Vapi imported:', Vapi);
        console.log('Vapi type:', typeof Vapi);

        let vapi = null;
        let assistantId = null;
        let isCallActive = false;

        const statusEl = document.getElementById('status');
        const startCallBtn = document.getElementById('start-call');
        const endCallBtn = document.getElementById('end-call');
        const volumeContainer = document.getElementById('volume-container');
        const volumeLevel = document.getElementById('volume-level');
        const assistantInfo = document.getElementById('assistant-info');
        const assistantDetails = document.getElementById('assistant-details');
        const transcriptEl = document.getElementById('transcript');
        const transcriptContent = document.getElementById('transcript-content');

        function updateStatus(message, type = 'loading') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function addTranscript(speaker, text) {
            const entry = document.createElement('div');
            entry.className = 'transcript-entry';
            const speakerLabel = speaker === 'user' ? 'You' : 'Assistant';
            const speakerClass = speaker === 'user' ? 'transcript-user' : 'transcript-assistant';
            entry.innerHTML = `<span class="${speakerClass}">${speakerLabel}:</span> ${text}`;
            transcriptContent.appendChild(entry);
            transcriptEl.scrollTop = transcriptEl.scrollHeight;
        }

        async function loadAssistantConfig() {
            try {
                const response = await fetch('http://localhost:3000/assistant-id');
                if (!response.ok) {
                    throw new Error('Failed to fetch assistant configuration. Is the server running?');
                }

                const data = await response.json();
                assistantId = data.assistant_id;
                const publicKey = data.public_key;

                console.log('Assistant config loaded:', {
                    assistantId,
                    publicKeyPresent: !!publicKey,
                    publicKeyPrefix: publicKey ? publicKey.substring(0, 20) + '...' : 'null'
                });

                if (!publicKey) {
                    throw new Error('VAPI_PUBLIC_KEY not configured in environment');
                }

                // Show assistant details
                assistantDetails.innerHTML = `
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">
                        Assistant ID: <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">${assistantId}</code><br>
                        Tenant: <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">${data.tenant_id}</code><br>
                        Public Key: <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">${publicKey.substring(0, 20)}...</code>
                    </div>
                `;
                assistantInfo.style.display = 'block';

                // Initialize Vapi
                console.log('Initializing Vapi with public key...');
                vapi = new Vapi(publicKey);

                // Set up event listeners
                vapi.on('call-start', () => {
                    console.log('Call started');
                    isCallActive = true;
                    updateStatus('üìû Call active - Speak now!', 'calling');
                    startCallBtn.style.display = 'none';
                    endCallBtn.style.display = 'block';
                    endCallBtn.disabled = false;
                    volumeContainer.style.display = 'block';
                    transcriptEl.classList.add('active');
                    transcriptContent.innerHTML = '';
                });

                vapi.on('call-end', () => {
                    console.log('Call ended');
                    isCallActive = false;
                    updateStatus('‚úÖ Ready to start a new call', 'ready');
                    startCallBtn.style.display = 'block';
                    startCallBtn.disabled = false;
                    endCallBtn.style.display = 'none';
                    volumeContainer.style.display = 'none';
                    volumeLevel.style.width = '0%';
                });

                vapi.on('speech-start', () => {
                    console.log('User started speaking');
                });

                vapi.on('speech-end', () => {
                    console.log('User stopped speaking');
                });

                vapi.on('volume-level', (volume) => {
                    const percentage = Math.min(100, volume * 100);
                    volumeLevel.style.width = `${percentage}%`;
                });

                vapi.on('error', async (error) => {
                    console.error('Vapi error:', error);

                    let errorMessage = 'Unknown error';

                    // Handle Response object errors
                    if (error instanceof Response) {
                        try {
                            const errorData = await error.json();
                            errorMessage = errorData.message || errorData.error || `HTTP ${error.status}`;
                            console.error('Error details:', errorData);
                        } catch {
                            errorMessage = `HTTP ${error.status}: ${error.statusText}`;
                        }
                    } else if (error.message) {
                        errorMessage = error.message;
                    }

                    updateStatus(`‚ùå Error: ${errorMessage}`, 'error');
                    isCallActive = false;
                    startCallBtn.style.display = 'block';
                    startCallBtn.disabled = false;
                    endCallBtn.style.display = 'none';
                    volumeContainer.style.display = 'none';
                });

                vapi.on('message', (message) => {
                    console.log('Message:', message);

                    // Show transcript for user and assistant speech
                    if (message.type === 'transcript' && message.transcriptType === 'final') {
                        if (message.role === 'user') {
                            addTranscript('user', message.transcript);
                        } else if (message.role === 'assistant') {
                            addTranscript('assistant', message.transcript);
                        }
                    }
                });

                updateStatus('‚úÖ Ready to start call', 'ready');
                startCallBtn.disabled = false;

            } catch (error) {
                console.error('Setup error:', error);
                updateStatus(`‚ùå Setup failed: ${error.message}`, 'error');
            }
        }

        startCallBtn.addEventListener('click', async () => {
            if (!assistantId || !vapi) {
                updateStatus('‚ùå Assistant not configured', 'error');
                return;
            }

            try {
                startCallBtn.disabled = true;
                updateStatus('üìû Starting call...', 'loading');

                console.log('Starting call with assistant ID:', assistantId);
                await vapi.start(assistantId);
            } catch (error) {
                console.error('Failed to start call:', error);

                let errorMessage = 'Unknown error';
                if (error instanceof Response) {
                    try {
                        const errorData = await error.json();
                        errorMessage = errorData.message || errorData.error || `HTTP ${error.status}: ${error.statusText}`;
                        console.error('Start call error details:', errorData);
                    } catch {
                        errorMessage = `HTTP ${error.status}: ${error.statusText}`;
                    }
                } else if (error.message) {
                    errorMessage = error.message;
                }

                updateStatus(`‚ùå Failed to start call: ${errorMessage}`, 'error');
                startCallBtn.disabled = false;
            }
        });

        endCallBtn.addEventListener('click', () => {
            if (vapi && isCallActive) {
                vapi.stop();
                endCallBtn.disabled = true;
            }
        });

        // Load configuration on page load
        loadAssistantConfig();
    </script>
</body>
</html>
