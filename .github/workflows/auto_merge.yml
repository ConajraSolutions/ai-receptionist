name: Enable auto-merge for labeled PRs

on:
  workflow_run:
    workflows: ["Node.js CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  enable_auto_merge:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Get PR number (from workflow_run)
        id: pr
        run: |
          PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"
          if [ -z "$PR_NUMBER" ]; then
            echo "No PR associated with this run."
            exit 0
          fi
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
      
      - name: Check PR has 'auto' label
        id: label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          HAS=$(gh pr view "$PR_NUMBER" -R "$REPO" --json labels --jq '[.labels[].name] | contains(["auto"])')
          echo "has_auto=$HAS" >> "$GITHUB_OUTPUT"
      
      - name: Check mergeability
        id: mergeable
        if: steps.label.outputs.has_auto == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          sleep 2
          M=$(gh pr view "$PR_NUMBER" -R "$REPO" --json mergeable --jq '.mergeable')
          echo "mergeable=$M" >> "$GITHUB_OUTPUT"
      
      - name: Enable auto-merge (no branch deletion)
        if: steps.label.outputs.has_auto == 'true' && steps.mergeable.outputs.mergeable != 'CONFLICTING'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          gh pr merge "$PR_NUMBER" -R "$REPO" --auto --squash


      - name: Discord (auto-merge enabled)
        if: steps.label.outputs.has_auto == 'true' && steps.mergeable.outputs.mergeable != 'CONFLICTING'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          test -n "$DISCORD_WEBHOOK_URL" || exit 0
          PR_URL="https://github.com/${REPO}/pull/${PR_NUMBER}"
          TITLE=$(gh pr view "$PR_NUMBER" -R "$REPO" --json title --jq '.title')

          curl -sS -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK_URL" <<EOF
          {
            "embeds": [
              {
                "title": "ðŸ”€ Auto-merge enabled",
                "url": "${PR_URL}",
                "description": "**Repo:** ${REPO}\n**PR:** #${PR_NUMBER} - ${TITLE}\n\nCI passed. This PR will merge automatically when GitHub allows it.",
                "color": 5793266
              }
            ]
          }
          EOF
