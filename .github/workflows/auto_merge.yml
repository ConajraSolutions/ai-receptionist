name: Auto-Merge PR

on:
  pull_request:
    types: [labeled, synchronize, reopened]
    branches: [main]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto_merge:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'auto')) ||
      (github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success')
    
    steps:
      - uses: actions/checkout@v4

      - name: Get PR number
        id: get_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "check_suite" ]; then
            # Get PR associated with this check suite
            PR_NUMBER=$(gh pr list --json number,headRefOid --jq ".[] | select(.headRefOid == \"${{ github.event.check_suite.head_sha }}\") | .number" | head -1)
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          
          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found"
            exit 0
          fi
          
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "Found PR #$PR_NUMBER"

      - name: Check if PR has auto label
        id: check_label
        if: steps.get_pr.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.get_pr.outputs.number }}"
          HAS_AUTO_LABEL=$(gh pr view "$PR_NUMBER" --json labels --jq '[.labels[].name] | contains(["auto"])')
          echo "has_label=$HAS_AUTO_LABEL" >> "$GITHUB_OUTPUT"
          echo "Has auto label: $HAS_AUTO_LABEL"

      - name: Wait for checks and enable auto-merge
        if: steps.check_label.outputs.has_label == 'true' && steps.get_pr.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.get_pr.outputs.number }}"
          
          echo "Checking current status of PR #$PR_NUMBER..."
          
          # Get PR status with details
          PR_STATUS=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '.statusCheckRollup')
          
          # Show all checks
          echo "=== All Checks ==="
          echo "$PR_STATUS" | jq -r '.[] | "\(.context // .name): \(.status // .state) - \(.conclusion // "N/A")"'
          echo "=================="
          
          # Wait up to 10 minutes for checks to complete
          TIMEOUT=600
          ELAPSED=0
          INTERVAL=10
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            PR_STATUS=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '.statusCheckRollup')
            
            # Count pending/in-progress checks
            PENDING=$(echo "$PR_STATUS" | jq -r 'select(.status == "PENDING" or .status == "IN_PROGRESS" or .state == "PENDING")' | wc -l)
            
            if [ "$PENDING" -eq 0 ]; then
              echo "All checks completed!"
              break
            fi
            
            # Show what we're waiting for
            echo "Still waiting... ($PENDING checks pending/in-progress)"
            echo "$PR_STATUS" | jq -r '.[] | select(.status == "PENDING" or .status == "IN_PROGRESS" or .state == "PENDING") | "  - \(.context // .name): \(.status // .state)"'
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "Timeout waiting for checks. Not enabling auto-merge."
            exit 0
          fi
          
          # Check if all required checks passed
          FAILED=$(echo "$PR_STATUS" | jq -r 'select(.conclusion == "FAILURE" or .conclusion == "CANCELLED")' | wc -l)
          
          if [ "$FAILED" -gt 0 ]; then
            echo "Some checks failed. Not enabling auto-merge."
            echo "$PR_STATUS" | jq -r '.[] | select(.conclusion == "FAILURE" or .conclusion == "CANCELLED") | "  ‚ùå \(.context // .name): \(.conclusion)"'
            gh pr comment "$PR_NUMBER" --body "‚ùå CI checks failed. Auto-merge will not be enabled."
            exit 0
          fi
          
          # Enable auto-merge
          echo "Enabling auto-merge for PR #$PR_NUMBER"
          gh pr merge "$PR_NUMBER" --auto --squash --delete-branch
          
          # Add a comment
          gh pr comment "$PR_NUMBER" --body "‚úÖ CI passed! Auto-merge enabled. This PR will merge automatically once all requirements are met."

      - name: Notify Discord
        if: steps.check_label.outputs.has_label == 'true' && steps.get_pr.outputs.number != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_NUMBER: ${{ steps.get_pr.outputs.number }}
          PR_TITLE: ${{ steps.conflicts.outputs.pr_title }}
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            PR_URL="https://github.com/${REPO}/pull/${PR_NUMBER}"
            PR_TITLE=$(gh pr view "$PR_NUMBER" --json title --jq '.title')
            PR_AUTHOR=$(gh pr view "$PR_NUMBER" --json author --jq '.author.login')
            
            curl -sS -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK_URL" <<EOF
          {
            "embeds": [
              {
                "title": "üîÄ Auto-merge enabled: PR #${PR_NUMBER}",
                "url": "${PR_URL}",
                "description": "**Repo:** ${REPO}\n**Author:** ${PR_AUTHOR}\n**PR:** #${PR_NUMBER}\n\nCI passed! PR will merge automatically.",
                "color": 5793266
              }
            ]
          }
          EOF
          fi
