name: Auto PR to main (and enable auto-merge)

on:
  push:
    branches-ignore:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  open_pr_and_automerge:
    runs-on: ubuntu-latest

    steps:
      - name: Create or update PR to main
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: ${{ github.ref_name }}
          title: "Auto PR: ${{ github.ref_name }}"
          body: |
            Automated PR from branch `${{ github.ref_name }}` into `main`.
            Triggered by: ${{ github.actor }}
          labels: |
            auto
          delete-branch: true

      # If a PR already exists, create-pull-request doesn't always output the PR number reliably
      # so we query GitHub for the PR associated with this branch.
      - name: Look up PR number for this branch
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          pr_number=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "${{ github.ref_name }}" \
            --base "main" \
            --state "open" \
            --json number \
            --jq '.[0].number')

          if [ -z "$pr_number" ] || [ "$pr_number" = "null" ]; then
            echo "No open PR found for branch ${{ github.ref_name }} -> main"
            exit 0
          fi

          echo "number=$pr_number" >> "$GITHUB_OUTPUT"

      - name: Enable auto-merge (squash) on the PR
        if: steps.pr.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          set -e

          # Get PR node id
          pr_id=$(gh api graphql -f query='
            query($owner:String!, $name:String!, $number:Int!) {
              repository(owner:$owner, name:$name) {
                pullRequest(number:$number) { id }
              }
            }' -f owner="${REPO%%/*}" -f name="${REPO##*/}" -F number="$PR_NUMBER" --jq '.data.repository.pullRequest.id')

          if [ -z "$pr_id" ] || [ "$pr_id" = "null" ]; then
            echo "Could not find PR id for #$PR_NUMBER"
            exit 1
          fi

          # Enable auto-merge (SQUASH). Other options: MERGE / REBASE
          gh api graphql -f query='
            mutation($pullRequestId:ID!) {
              enablePullRequestAutoMerge(input:{
                pullRequestId:$pullRequestId,
                mergeMethod:SQUASH
              }) {
                pullRequest { number }
              }
            }' -f pullRequestId="$pr_id" >/dev/null

          echo "Enabled auto-merge for PR #$PR_NUMBER"
