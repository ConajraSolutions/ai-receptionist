name: Node.js CI

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - run: npm ci

      - name: Build
        id: build
        run: npm run build --if-present
        env:
          CI: true
        continue-on-error: true

      - name: Fail + Discord (PR build failure)
        if: github.event_name == 'pull_request' && steps.build.outcome == 'failure' && matrix.node-version == '20.x'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          test -n "$DISCORD_WEBHOOK_URL" || exit 0
          PR_URL="https://github.com/${REPO}/pull/${PR_NUMBER}"

          curl -sS -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK_URL" <<EOF
          {
            "embeds": [
              {
                "title": "ðŸ”¨ Build failed",
                "url": "${RUN_URL}",
                "description": "**Repo:** ${REPO}\n**PR:** [#${PR_NUMBER} - ${PR_TITLE}](${PR_URL})\n\nBuild step failed.\n[View run](${RUN_URL})",
                "color": 15158332
              }
            ]
          }
          EOF
          exit 1

      - name: Test
        id: test
        run: |
          npm test 2>&1 | tee test-output.txt
          exit ${PIPESTATUS[0]}
        env:
          CI: true
        continue-on-error: true

      - name: Fail + Discord (PR test failure)
        if: github.event_name == 'pull_request' && steps.test.outcome == 'failure' && matrix.node-version == '20.x'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          test -n "$DISCORD_WEBHOOK_URL" || exit 1

          PR_URL="https://github.com/${REPO}/pull/${PR_NUMBER}"
          LOGS=$(tail -50 test-output.txt | head -c 3500)

          node <<NODE | curl -sS -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK_URL"
          const payload = {
            embeds: [
              {
                title: "âŒ PR tests failed",
                url: process.env.RUN_URL,
                description:
                  "**Repo:** ${REPO}\n" +
                  "**PR:** [#${PR_NUMBER} - ${PR_TITLE}](${PR_URL})\n\n" +
                  "```\n${LOGS}\n```\n" +
                  "[View run](${RUN_URL})",
                color: 15158332
              }
            ]
          };
          console.log(JSON.stringify(payload));
          NODE

          exit 1

      - name: Discord (PR CI success)
        if: github.event_name == 'pull_request' && matrix.node-version == '20.x' && success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          test -n "$DISCORD_WEBHOOK_URL" || exit 0
          PR_URL="https://github.com/${REPO}/pull/${PR_NUMBER}"

          curl -sS -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK_URL" <<EOF
          {
            "embeds": [
              {
                "title": "âœ… CI passed",
                "url": "${RUN_URL}",
                "description": "**Repo:** ${REPO}\n**PR:** [#${PR_NUMBER} - ${PR_TITLE}](${PR_URL})\n\nAll checks passed.\n[View run](${RUN_URL})",
                "color": 3066993
              }
            ]
          }
          EOF
