name: Node.js CI

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - run: npm ci
      - run: npm run build --if-present
      - run: npm test
        env:
          CI: true

      - name: Collect commit info
        if: github.event_name == 'push' && matrix.node-version == '20.x'
        id: info
        run: |
          echo "short_sha=$(git rev-parse --short '${{ github.sha }}')" >> "$GITHUB_OUTPUT"
          echo "subject=$(git log -1 --pretty=%s)" >> "$GITHUB_OUTPUT"

          DELIM="__GHA_DELIM_$(date +%s)__"

          {
            echo "body<<$DELIM"
            git log -1 --pretty=%B
            echo "$DELIM"
          } >> "$GITHUB_OUTPUT"

          {
            echo "files<<$DELIM"
            git diff --name-status '${{ github.event.before }}' '${{ github.sha }}' || git show --name-status --pretty="" '${{ github.sha }}'
            echo "$DELIM"
          } >> "$GITHUB_OUTPUT"

      - name: Notify Discord
        if: github.event_name == 'push' && matrix.node-version == '20.x'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          SUBJECT: ${{ steps.info.outputs.subject }}
          BODY: ${{ steps.info.outputs.body }}
          FILES_RAW: ${{ steps.info.outputs.files }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          BEFORE: ${{ github.event.before }}
        run: |
          test -n "$DISCORD_WEBHOOK_URL" || (echo "Missing DISCORD_WEBHOOK_URL secret" && exit 1)

          node <<'NODE' | curl -sS -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK_URL"
          const fs = (process.env.FILES_RAW || "").split("\n").filter(Boolean);
          const max = 40;
          const shown = fs.slice(0, max).join("\n");
          const more = fs.length > max ? `\n...and ${fs.length - max} more` : "";
          const files = shown + more;

          const commitUrl = `https://github.com/${process.env.REPO}/commit/${process.env.SHA}`;
          const compareUrl = `https://github.com/${process.env.REPO}/compare/${process.env.BEFORE}...${process.env.SHA}`;
          const shortSha = (process.env.SHA || "").slice(0, 7);

          const payload = {
            embeds: [
              {
                title: `âœ… New push to main: ${process.env.SUBJECT || "(no subject)"}`,
                url: commitUrl,
                description:
                  `**Repo:** ${process.env.REPO}\n` +
                  `**SHA:** ${shortSha}\n\n` +
                  `**Commit message:**\n${process.env.BODY || ""}\n\n` +
                  `**Files changed:**\n\`\`\`\n${files}\n\`\`\`\n` +
                  `[View compare](${compareUrl})`,
                color: 3066993
              }
            ]
          };

          process.stdout.write(JSON.stringify(payload));
          NODE
